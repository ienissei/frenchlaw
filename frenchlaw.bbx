%%
%%	This is file "frenchlaw.bbx", which is part of the "frenchlaw" package
%%	Copyright 2009--2014: Fora VERN -- ienissei (at) gmail (dot) com
%%	This work may be distributed and/or modified under the conditions of the
%%	LaTeX Project Public License, either version 1.3 of this license or, at your
%%	option, any later version.
%%
%%	The latest version of the license can be found at:
%%		http://www.latex-project.org/lppl.txt
%%	and version 1.3 or later is part of all distributions of LaTeX, 2005/12/01 or later.
%%
%%	This work has the LPPL maintenance status "author-maintained".
%%	This work consists of the files listed in the README file.
%%

%%	WARNING: Please note that this is a BibLaTeX style file for "frenchlaw.cls"

\ProvidesFile{frenchlaw.bbx}%
	[2014/09/30 v.0.9. Bibliography style for French legal documents]

% #####	OPTIONS	#####

%	Create bibliography toggles
\newtoggle{bbx:isbn}
\newtoggle{bbx:url}
\newtoggle{bbx:doi}
\newtoggle{bbx:eprint}
\newtoggle{bbx:related}
\newtoggle{bbx:dashed}

%	Declare bibliography options
\DeclareBibliographyOption{isbn}[true]{%
	\settoggle{bbx:isbn}{#1}}
\DeclareBibliographyOption{url}[true]{%
	\settoggle{bbx:url}{#1}}
\DeclareBibliographyOption{doi}[true]{%
	\settoggle{bbx:doi}{#1}}
\DeclareBibliographyOption{eprint}[true]{%
	\settoggle{bbx:eprint}{#1}}
\DeclareBibliographyOption{related}[true]{%
	\settoggle{bbx:related}{#1}}
\DeclareBibliographyOption{dashed}[true]{%
	\settoggle{bbx:dashed}{#1}
	\iftoggle{bbx:dashed}{\ExecuteBibliographyOptions{pagetracker}}{}}

%	Execute bibliography options
\ExecuteBibliographyOptions{isbn,url,doi,eprint,related,dashed,%
	sorting=nymdt,useeditor=false,usetranslator=false,language=auto}
\ExecuteBibliographyOptions[reference]{useauthor=false}

% #####	SORTING	#####

%	Sort entries by {name/institution} + year + day + month + title
\DeclareSortingScheme{nymdt}{
	\sort{\field{presort}}
	\sort[final]{\field{sortkey}}
	\sort{	\name{sortname}
			\name{author}
			\name{editor}
			\name{translator}}
	\sort{\field{year}}
	\sort{\field{month}}
	\sort{\field{day}}
	\sort{	\field{sorttitle}
			\field{title}}
}

\DeclareSortingScheme{reference}{
	\sort{\field{presort}}
	\sort[final]{\field{sortkey}}
	\sort{	\field{sorttitle}
			\field{title}}
}

\DeclareSortingScheme{legislation}{
	\sort{\field{presort}}
	\sort[final]{\field{sortkey}}
	\sort{\field{type}}
	\sort{\list{institution}}
	\sort{\field{year}}
	\sort{\field{month}}
	\sort{\field{day}}
	\sort{\field{number}}
	\sort{	\field{sorttitle}
			\field{title}}
}

\DeclareSortingScheme{jurisdiction}{
	\sort{\field{presort}}
	\sort[final]{\field{sortkey}}
	\sort{\list{institution}}
	\sort{\field{year}}
	\sort{\field{month}}
	\sort{\field{day}}
	\sort{\field{number}}
	\sort{	\field{sorttitle}
			\field{title}}
}

\DeclareSortingScheme{shortjournal}{
	\sort{\field{shortjournal}}
	\sort{\field{journal}}
}

% #####	FIELD FORMATS	#####

%	Define {title} fields
\DeclareFieldFormat[inbook,thesis]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[commentary]{title}{\mkbibquote{#1}}
\DeclareFieldFormat[shortjournal]{title}{\mkbibemph{#1}}

% Define various numbering fields
\DeclareFieldFormat{number}{\bibstring{number}\addnbthinspace#1}%
\DeclareFieldFormat[article,periodical]{number}{\bibstring{number}\addnbthinspace#1}
\DeclareFieldFormat[article,periodical]{volume}{\bibstring{volume}~#1}
\DeclareFieldFormat[inreference]{title}{\mkbibemph{\MakeLowercase{\bibstring{verbo}}}~#1}

%	TODO » Delete
\DeclareFieldFormat[customa]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[customb]{title}{{#1}}
\DeclareFieldFormat[customc]{title}{{#1}}

%	Define a [plain] field format
\DeclareFieldAlias{plain}{noformat}

% #####	NAME FORMATS	#####

%	Use French formatting for all last names
\protect\def\mkbibnamelast#1{\textsc{\textnohyphenation{#1}}}

%	Use last-name only for the first author in the entry.
\DeclareNameAlias{author}{last-first/first-last}
\DeclareNameAlias{editor}{last-first/first-last}
\DeclareNameAlias{translator}{last-first/first-last}

%\DeclareNameAlias[jurisdiction]{institution}{sortname}%	TODO	» Utilité?

%	TODO » NameFormat first-last if bbx:related -- insérer dans une commande \DeclareNameFormat{author}
% Utiliser \ifbibliography pour trier entre les auteurs alphabétiques et ceux dans l'ordre normal (?)

% #####	PUNCTUATION	#####

%	Redefine punctuation
\renewcommand*{\newunitpunct}{\adddot\space\bibsentence}% Avoid double spaces in English
\renewcommand*{\subtitlepunct}{\addcolon\addspace}
\renewcommand*{\intitlepunct}{\addspace}
\renewcommand*{\textcitedelim}{\addsemicolon\addspace}

%	TODO » Create commands, e.g. for commas or colons

% #####	VERTICAL ALIGNMENT	#####

\setlength{\bibitemsep}{0pt}
\setlength{\bibnamesep}{0pt}
\setlength{\bibinitsep}{0pt}
\setlength{\bibparsep}{0pt}

\defbibheading{subbibliography}[\refname]{%
	\setlength{\beforesecskip}{2\baselineskip}
	\renewcommand*{\large}{\fontsize{14}{14.5}\selectfont}
	\section*{#1}%
	\if@twoside\markright{\MakeUppercase{#1}}\fi}

\defbibheading{subbibintoc}[\refname]{%
	\setlength{\beforesecskip}{2\baselineskip}
	\renewcommand*{\large}{\fontsize{14}{14.5}\selectfont}
	\section*{#1}%
	\addcontentsline{toc}{section}{#1}%
	\if@twoside\markright{\MakeUppercase{#1}}\fi}

% #####	CITATION PROCESSORS	#####

%	Set up a citation command for cross-references
\DeclareCiteCommand{\bbx@crossref}
	{}
	{\printnames[labelname]{labelname}%
	 \setunit*{\addcomma\addspace}\newblock
	 \printfield[title]{labeltitle}}
	{}
	{}

%	TODO » Copier les defbibfilter et catégories ici
%	Set up a bibliography check that removes duplicate journal titles
\defbibcheck{shortjournal}{%
	\iffieldundef{shortjournal}
		{\skipentry}
		{\iffieldundef{journaltitle}
			{\skipentry}
			{\ifcsdef{\strfield{shortjournal}=\strfield{journaltitle}}
				{\skipentry}
				{\savefieldcs{journaltitle}%
					{\strfield{shortjournal}=\strfield{journaltitle}}}}}}

% #####	BIBLIOGRAPHY DRIVERS	#####

%	Create hooks for bibliography drivers
\newbibmacro*{begentry}{}
\newbibmacro*{finentry}{\finentry}

%	Define aliases for bibliography drivers
\DeclareBibliographyAlias{review}{article}
\DeclareBibliographyAlias{periodical}{article}
\DeclareBibliographyAlias{suppperiodical}{article}
\DeclareBibliographyAlias{mvbook}{book}
\DeclareBibliographyAlias{bookinbook}{inbook}
\DeclareBibliographyAlias{suppbook}{inbook}
\DeclareBibliographyAlias{mvcollection}{collection}
\DeclareBibliographyAlias{suppcollection}{incollection}
\DeclareBibliographyAlias{mvproceedings}{proceedings}
\DeclareBibliographyAlias{mvreference}{reference}
\DeclareBibliographyAlias{suppreference}{inreference}
\DeclareBibliographyAlias{*}{misc}

%	Define a driver for <article> entries
\DeclareBibliographyDriver{article}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{bytranslator+others}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\usebibmacro{journal+issue+date}%
	\newunit\newblock
	\iftoggle{bbx:isbn}
		{\printfield{issn}}
		{}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <book> entries
\DeclareBibliographyDriver{book}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/editor+others/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+title}%
	% \newunit%
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{byeditor+others}%
	\newunit\newblock
	\printfield{edition}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\addspace}
	\usebibmacro{series+number}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\newunit\newblock
	\iftoggle{bbx:isbn}
		{\printfield{isbn}}
		{}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <collection> entries
\DeclareBibliographyDriver{collection}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+title}%
	% \newunit%
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{editor-bis}%
	\newunit\newblock
	\usebibmacro{bytranslator+others}%
	\newunit\newblock
	\printfield{edition}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\addspace}
	\usebibmacro{series+number}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\newunit\newblock
	\iftoggle{bbx:isbn}
		{\printfield{isbn}}
		{}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <proceedings> entries
\DeclareBibliographyDriver{proceedings}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{editor+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+title}%
	% \newunit
	% \printlist{language}%
	\newunit\newblock
	\usebibmacro{event+venue+date}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{editor-bis}%
	\newunit\newblock
	\usebibmacro{bytranslator+others}%
	\newunit\newblock
	\printfield{edition}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\printlist{organization}%
	\newunit
	\usebibmacro{publisher+location+date}%
	\setunit{\addspace}
	\usebibmacro{series+number}%
	\newunit
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\newunit\newblock
	\iftoggle{bbx:isbn}
		{\printfield{isbn}}
		{}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <reference> entries
\DeclareBibliographyDriver{reference}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+title}%
	% \newunit%
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{editor-bis}%
	\newunit\newblock
	\usebibmacro{bytranslator+others}%
	\newunit\newblock
	\printfield{edition}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\addspace}
	\usebibmacro{series+number}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\newunit\newblock
	\iftoggle{bbx:isbn}
		{\printfield{isbn}}
		{}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <inbook> entries
\DeclareBibliographyDriver{inbook}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit%
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\iffieldundef{crossref}%
		{\newunit\newblock
		 \usebibmacro{in:}%
		 \ifnameundef{bookauthor}
			{}
		 	{\usebibmacro{bybookauthor}%
			 \setunit{\addcomma\addspace}\newblock}%
		 \usebibmacro{maintitle+booktitle}%
		 \newunit\newblock
		 \usebibmacro{byeditor+others}%
		 \newunit\newblock
		 \printfield{edition}%
		 \newunit\newblock
		 \printfield{note}%
		 \newunit\newblock
		 \usebibmacro{publisher+location+date}%
		 \setunit{\addspace}
		 \usebibmacro{series+number}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{volume+part}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{chapter+pages}%
		 \newunit\newblock
		 \iftoggle{bbx:isbn}
			{\printfield{isbn}}
			{}%
		 \newunit\newblock
		 \usebibmacro{doi+eprint+url}%
		 \newunit\newblock
		 \usebibmacro{addendum+pubstate}%
		 \setunit{\bibpagerefpunct}\newblock
		 \usebibmacro{pageref}%
		 \newunit\newblock
		 \iftoggle{bbx:related}
			{\usebibmacro{related:init}%
			 \usebibmacro{related}}
			{}%
		}%
		{\newunit\newblock
		 \usebibmacro{see:}%
		 \bbx@crossref{\thefield{crossref}}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{volume+part}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{chapter+pages}}%
	\usebibmacro{finentry}}

%	Define a driver for <incollection> entries
\DeclareBibliographyDriver{incollection}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\iffieldundef{crossref}%
		{\newunit\newblock
		 \usebibmacro{in:}%
		 \ifnameundef{bookauthor}
			{}
		 	{\usebibmacro{bybookauthor}%
			 \setunit{\addcomma\addspace}\newblock}%
		 \usebibmacro{maintitle+booktitle}%
		 \newunit\newblock
		 \usebibmacro{editor-bis}%
		 \newunit\newblock
		 \usebibmacro{bytranslator+others}%
		 \newunit\newblock
		 \printfield{edition}%
		 \newunit\newblock
		 \printfield{note}%
		 \newunit\newblock
		 \usebibmacro{publisher+location+date}%
		 \setunit{\addspace}
		 \usebibmacro{series+number}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{volume+part}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{chapter+pages}%
		 \newunit\newblock
		 \iftoggle{bbx:isbn}
			{\printfield{isbn}}
			{}%
		 \newunit\newblock
		 \usebibmacro{doi+eprint+url}%
		 \newunit\newblock
		 \usebibmacro{addendum+pubstate}%
		 \setunit{\bibpagerefpunct}\newblock
		 \usebibmacro{pageref}%
		 \newunit\newblock
		 \iftoggle{bbx:related}
			{\usebibmacro{related:init}%
			 \usebibmacro{related}}
			{}%
		}%
		{\newunit\newblock
		 \usebibmacro{see:}%
		 \bbx@crossref{\thefield{crossref}}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{volume+part}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{chapter+pages}}%
	\usebibmacro{finentry}}

%	Define a driver for <inproceedings> entries
\DeclareBibliographyDriver{inproceedings}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\iffieldundef{crossref}%
		{\newunit\newblock
		 \usebibmacro{in:}%
		 \usebibmacro{maintitle+booktitle}%
		 \newunit\newblock
		 \usebibmacro{event+venue+date}%
		 \newunit\newblock
		 \usebibmacro{editor-bis}%
		 \newunit\newblock
		 \usebibmacro{bytranslator+others}%
		 \newunit\newblock
		 \printfield{edition}%
		 \newunit\newblock
		 \printfield{note}%
		 \newunit\newblock
		 \printlist{organization}%
		 \newunit
		 \usebibmacro{publisher+location+date}%
		 \setunit{\addspace}
		 \usebibmacro{series+number}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{volume+part}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{chapter+pages}%
		 \newunit\newblock
		 \iftoggle{bbx:isbn}
			{\printfield{isbn}}
			{}%
		 \newunit\newblock
		 \usebibmacro{doi+eprint+url}%
		 \newunit\newblock
		 \usebibmacro{addendum+pubstate}%
		 \setunit{\bibpagerefpunct}\newblock
		 \usebibmacro{pageref}%
		 \newunit\newblock
		 \iftoggle{bbx:related}
			{\usebibmacro{related:init}%
			 \usebibmacro{related}}
			{}%
		}%
		{\newunit\newblock
		 \usebibmacro{see:}%
		 \bbx@crossref{\thefield{crossref}}%
		 \setunit{\addcomma\addspace}\newblock
		 \usebibmacro{volume+part}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{chapter+pages}}%
	\usebibmacro{finentry}}

%	Define a driver for <inreference> entries
\DeclareBibliographyDriver{inreference}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	%\usebibmacro{in:}% No Crossref, no {in}
	\ifnameundef{bookauthor}
		{}
	 	{\usebibmacro{bybookauthor}%
		 \setunit{\addcomma\addspace}\newblock}%
	\usebibmacro{maintitle+booktitle}%
	\newunit\newblock
	\usebibmacro{editor-bis}%
	\newunit\newblock
	\usebibmacro{bytranslator+others}%
	\newunit\newblock
	\printfield{edition}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\addspace}
	\usebibmacro{series+number}%
	\newunit\newblock
	\iftoggle{bbx:isbn}
		{\printfield{isbn}}
		{}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <thesis> entries
\DeclareBibliographyDriver{thesis}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\printfield{type}%
	\newunit
	\usebibmacro{institution+location+date}%
	\newunit
	\printfield{pagetotal}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{chapter+pages}%
	\newunit\newblock
	\iftoggle{bbx:isbn}
		{\printfield{isbn}}
		{}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <misc> entries
\DeclareBibliographyDriver{misc}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\usebibmacro{author/editor+others/translator+others}%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\setunit{\addcomma\addspace}\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{byeditor+others}%
	\newunit\newblock
	\printfield{howpublished}%
	\newunit\newblock
	\printfield{type}%
	\newunit
	\printfield{version}%
	\newunit\newblock
	\printfield{note}%
	\newunit\newblock
	\usebibmacro{organization+location+date}%
	\newunit\newblock
	\usebibmacro{doi+eprint+url}%
	\newunit\newblock
	\usebibmacro{addendum+pubstate}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\newunit\newblock
	\iftoggle{bbx:related}
		{\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driveer for <legislation> entries
\DeclareBibliographyDriver{legislation}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\iffieldundef{type}
		{}
		{\printfield{type}%
		 \setunit{\addnbspace}}%
	\iflistundef{institution}
		{}
		{\printtext[parens]{\printlist{institution}}
		 \setunit{\addspace}}%
	\iffieldundef{number}
		{}
		{\printfield{number}%
		 \setunit{\addspace}}%
	\iflistundef{location}
		{\ifthenelse{\iffieldundef{day}\AND\iffieldundef{month}\AND\iffieldundef{year}}
			{}
			{\bibstring{fromdate}%
			 \setunit{\addspace}
			 \usebibmacro{date}%
			 \setunit{\addspace}}}
		{}%
	\printfield{title}%
	\iflistundef{location}
		{}
		{\setunit{\addspace}
		 \bibstring{signedat}%
		 \setunit{\addspace}
		 \printlist{location}%
		 \setunit{\addspace}
		 \ifthenelse{\iffieldundef{day}\AND\iffieldundef{month}\AND\iffieldundef{year}}
			{}
			{\bibstring{ondate}%
			 \setunit{\addspace}
			 \usebibmacro{date}%
			 \setunit{\addspace}}}%
	% Primary citations and references print the series and commentaries
	\iftoggle{bbx:related}
		{\setunit{\addcomma\addspace}\newblock
		 \printfield{series}%
		 \newunit\newblock
		 \printfield{note}%
		 \newunit\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <jurisdiction> entries
\DeclareBibliographyDriver{jurisdiction}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\printlist{institution}%
	\ifkeyword{CEDH}
		% Define ECHR case citations
		{\setunit{\addcomma\addspace}
		 \printfield{title}%
		 \iffieldundef{type}
		 	{}
			{\setunit{\addspace}
		 	 \printtext[parens]{\printfield{type}}}%
		 \setunit*{\addcomma\addspace}
		 \usebibmacro{date}%
		 \iffieldundef{number}
		 	{}
		 	{\setunit*{\addcomma\addspace}
		 	 \printfield{number}}}%
		{\ifthenelse{	\ifkeyword{CC}\OR\ifkeyword{CConst}\OR
						\ifkeyword{CJUE}\OR\ifkeyword{CJCE} }
			% Define CJEU and Constitutional Court case citations
			{\setunit{\addcomma\addspace}
			 \printfield{type}%
			 \setunit{\addspace\midsentence}
			 \printfield{number}%
			 \setunit{\addspace}
			 \bibstring{fromdate}%
			 \setunit{\addspace}
			 \usebibmacro{date}%
			 \iffieldundef{title}
			 	{}
			 	{\setunit{\addcomma\addspace}
				 \printfield{title}}}%
			% Define generic case citations
			{\setunit{\addcomma\addspace}
			 \printfield{type}%
			 \setunit{\addcomma\addspace}
			 \usebibmacro{date}%
			 \iffieldundef{title}
			 	{}
			 	{\setunit{\addcomma\addspace}
				 \printfield{title}}%
			 \iffieldundef{number}
			 	{}
			 	{\setunit{\addcomma\addspace}
			 	 \printfield{number}}}}%
	% Primary citations and references print the series and commentaries
	\iftoggle{bbx:related}
		{\iffieldundef{series}
			{}
			{\setunit{\addcomma\addspace}
			 \printfield{series}}%
		 \setunit{\addcolon\addspace}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <commentary> entries
\DeclareBibliographyDriver{commentary}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\ifrelatedloop
		% Long citation for stand-alone references
		{\usebibmacro{author}%
		 \setunit{\labelnamepunct}\newblock
		 \usebibmacro{title}%
		 \setunit{\addcomma\addspace}\newblock
		 \usebibmacro{journal+issue+date}%
		 \setunit{\addcomma\addspace}\newblock
		 \settoggle{bbx:related}{false}%
		 \printfield{type}%
		 \setunit{\addspace}
		 \bibstring{under}%
		 \setunit{\addspace}
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		% Short citation -- after the case citation
		{\printfield{type}%
		 \setunit{\addspace}%
		 \usebibmacro{author}%
		 \setunit{\addcomma\addspace}\newblock
		 \usebibmacro{journal+issue+date}}%
	\usebibmacro{finentry}}

%	Define a driver for <shortjournal> abreviations
\DeclareBibliographyDriver{shortjournal}{%
	\printfield[plain]{journaltitle}}

\DeclareBibliographyDriver{shortauthor}{% TODO
	\usedriver{}{\thefield{entrytype}}%
	\setunit{\addcomma\addspace}
	\printtext{\bibstring{citedas}}%
	\setunit{\addspace}
	\printnames{shortauthor}%
	\setunit{\addcomma\addspace}
	\printfield{shorttitle}
	\usebibmacro{finentry}}

%	TODO » Delete
\DeclareBibliographyDriver{customa}{%
	\printfield{title}%
	\nopunct}
\DeclareBibliographyDriver{customb}{%
	\printfield[plain]{title}%
	\nopunct}
\DeclareBibliographyDriver{customc}{%
	\printfield[plain]{title}%
	\nopunct}

% #####	CUSTOM BIBLIOGRAPHY MACROS	#####

\renewbibmacro*{in:}{%
	\bibstring{in}%
	\setunit{\addspace}}

\newbibmacro*{see:}{%
	\bibstring{see}%
	\setunit{\addspace}}

%	Create a macro for collection/proceedings editors
\newbibmacro*{editor-bis}{%
	\ifnameundef{editor}
		{}
		{\printnames[labelname]{editor}%
		 \setunit{\addnbspace}%
		 \ifthenelse{	\value{listcount} > 1 }
			{\printtext[parens]{\bibstring{compilers}}}
			{\printtext[parens]{\bibstring{compiler}}}%
		 \clearname{editor}}}

%	Biblatex.def forgot to format the by-bookauthor properly
\renewbibmacro*{bybookauthor}{%
	\ifnamesequal{author}{bookauthor}
		{}
		{\printnames[byauthor]{bookauthor}}}

%	Create macros for printing title elements
\newbibmacro*{maintitle+title}{%
	\iffieldsequal{maintitle}{title}
		{\clearfield{maintitle}%
		  \clearfield{mainsubtitle}%
		  \clearfield{maintitleaddon}}
		{\usebibmacro{maintitle}}%
	\usebibmacro{title}}

\newbibmacro*{maintitle+booktitle}{%
	\iffieldsequal{maintitle}{booktitle}
		{\clearfield{maintitle}%
		  \clearfield{mainsubtitle}%
		  \clearfield{maintitleaddon}}
		{\usebibmacro{maintitle}}%
	\usebibmacro{booktitle}}

%	Create a macro for journal titles + citation in French and English
\newbibmacro*{journal+issue+date}{%
	\iffieldundef{shortjournal}
		{\usebibmacro{journal}}
		{\printfield[journaltitle]{shortjournal}}%
	\midsentence%
	\setunit{\addcomma\addspace}
	\printfield{series}%
	\setunit{\addcomma\addspace}
	\iffieldequalstr{langid}{french}%
		{\iffieldundef{part}
			{\ifthenelse{ \iffieldundef{number}\AND
						  \iffieldundef{volume}\AND
						  \iffieldundef{month} }
				% Ex: RTD civ. 2010.123
				{\setunit{\nopunct\addspace}
				 \printfield{year}%
				 \setunit{\adddot}
				 \printfield[plain]{pages}%
				 \clearfield{pages}%
				 \clearfield{issue}}
				% Ex: Gaz. Pal., n°123, 5 janv. 2015, p. 123
				% --- Arch. phil. dr., n°123, 2015/4, p. 123
				{\setunit{\addcomma\addspace}
				 \printfield{number}%
				 \setunit{\addcomma\addspace}
				 \iffieldundef{volume}
				 	{\usebibmacro{date}}
				 	{\printfield{year}%
				 	 \setunit{\addslash}
					 \printfield[plain]{volume}}}}
			% Ex: JCP 1950, I, 12345 -- JCP 2015, chron., 123
			{\printfield{year}%
			 \setunit{\addcomma\addspace}
			 \printfield[plain]{part}%
			 \setunit{\addcomma\addspace}
			 \printfield[plain]{number}}}
		{\printfield{volume}%
		 \setunit{\addcomma\addspace}
		 \printfield{number}%
		 \setunit{\addspace}
		 \printtext[parens]{\usebibmacro{date}}}%
	\iffieldundef{issue}
		{}
		{\setunit{\addcolon\addspace}
		 \usebibmacro{issue}}%
	\iffieldundef{pages}
		{}
		{\setunit{\addcolon\addspace}
		 \usebibmacro{pages}}%
	\newunit
	\printfield{eid}}

%	Create a macro for event venues + dates
\newbibmacro*{event+venue+date}{%
	\printfield{eventtitle}%
	\setunit{\addspace}
	\printfield{eventtitleaddon}%
	\ifthenelse{	\iffieldundef{eventyear} \OR
					\iffieldundef{eventmonth} \OR
					\iffieldundef{eventday} }
		{}
		{\setunit{\addcomma\addspace}
		 \printeventdate}
	\setunit{\addspace}
	\iffieldundef{venue}
		{}
		{\printtext[parens]{\printfield{venue}}}}

%	Create macros for publication information
\newbibmacro*{publisher+location+date}{%
	\printlist{location}%
	\iflistundef{location}
		{\setunit*{\addcomma\space}}
		{\setunit*{\addcolon\space}}%
	\printlist{publisher}%
	\setunit*{\addcomma\space}%
	\usebibmacro{date}}

\newbibmacro*{institution+location+date}{%
	\printlist{location}%
	\iflistundef{location}
		{\setunit{\addcomma\space}}
		{\setunit{\addcolon\space}}%
	\printlist{institution}%
	\setunit*{\addcomma\space}%
	\usebibmacro{date}}

\newbibmacro*{organization+location+date}{%
	\printlist{location}%
	\iflistundef{organization}
		{\setunit*{\addcomma\space}}
		{\setunit*{\addcolon\space}}%
	\printlist{organization}%
	\setunit*{\addcomma\space}%
	\usebibmacro{date}}

\newbibmacro*{series+number}{%
	\iffieldundef{series}
		{}
		{\printtext[parens]{%
			\printfield{series}%
			\setunit{\addcomma\addspace}%
			\printfield{number}}}}

%	Create macros for pagination + volumes
\newbibmacro*{pagetotal/volumes}{%
	\iffieldundef{volumes}
		{\printfield{pagetotal}}%
		{\printfield{volumes}}%
}

\newbibmacro*{volume+part}{%
	\printfield{volume}%
	\printfield{part}}

\newbibmacro*{chapter+pages}{%
	\printfield{chapter}%
	\usebibmacro{pages}}

\newbibmacro*{pages}{%
	\setunit{\bibpagespunct}
	\printfield{pages}%
	\iffieldint{pages}
		{\addnbspace\bibstring{sequentes}}
		{}}

%	Create macros for standard book numbers
\newbibmacro*{doi+eprint+url}{%
	\iftoggle{bbx:doi}
		{\printfield{doi}}
		{}%
	\newunit\newblock
	\iftoggle{bbx:eprint}
		{\usebibmacro{eprint}}
		{}%
	\newunit\newblock
	\iftoggle{bbx:url}
		{\usebibmacro{url+urldate}}
		{}}

\newbibmacro*{addendum+pubstate}{%
	\printfield{addendum}%
	\newunit\newblock
	\printfield{pubstate}}


% #####	DASHES FOR LAST-NAME IN BIBLIOGRAPHY	#####

\InitializeBibliographyStyle{\global\undef\bbx@lasthash}

\newbool{bbx@inset}

\DeclareBibliographyDriver{set}{%
	\booltrue{bbx@inset}%
	\entryset{}{}%
	\newunit\newblock
	\usebibmacro{setpageref}%
	\finentry}

\newbibmacro*{bbx:savehash}{\savefield{fullhash}{\bbx@lasthash}}

\renewbibmacro*{author}{%
	\ifthenelse{	\ifuseauthor\AND\NOT\ifnameundef{author} }
		{\usebibmacro{bbx:dashcheck}
			{\bibnamedash}
			{\printnames{author}%
			 \setunit{\addcomma\space}%
			 \usebibmacro{bbx:savehash}}%
		 \usebibmacro{authorstrg}}
		{\global\undef\bbx@lasthash}}

\renewbibmacro*{editor}{%
	\usebibmacro{bbx:editor}{editorstrg}}
\renewbibmacro*{editor+others}{%
	\usebibmacro{bbx:editor}{editor+othersstrg}}

\newbibmacro*{bbx:editor}[1]{%
	\ifthenelse{	\ifuseeditor\AND\NOT\ifnameundef{editor} }
		{\usebibmacro{bbx:dashcheck}
			{\bibnamedash}
			{\printnames{editor}%
			 \setunit{\addcomma\space}%
			 \usebibmacro{bbx:savehash}}%
		 \usebibmacro{#1}%
		 \clearname{editor}}
		{\global\undef\bbx@lasthash}}

\renewbibmacro*{translator}{%
	\usebibmacro{bbx:translator}{translatorstrg}}
\renewbibmacro*{translator+others}{%
	\usebibmacro{bbx:translator}{translator+othersstrg}}

\newbibmacro*{bbx:translator}[1]{%
	\ifthenelse{ \ifusetranslator\AND\NOT\ifnameundef{translator} }
		{\usebibmacro{bbx:dashcheck}
			{\bibnamedash}
			{\printnames{translator}%
			 \setunit{\addcomma\space}%
			 \usebibmacro{bbx:savehash}}%
		 \usebibmacro{#1}%
		 \clearname{translator}}
		{\global\undef\bbx@lasthash}}

\newbibmacro*{bbx:dashcheck}[2]{%
	\ifboolexpr{	test {\iffieldequals{fullhash}{\bbx@lasthash}}
					and
					not test \iffirstonpage
					and
						( not bool {bbx@inset}
						or
						test {\iffieldequalstr{entrysetcount}{1}} ) }
		{#1}
		{#2}}

% #####	RELATED FIELD LOOP	#####

\renewcommand*{\relateddelim}{\addsemicolon\addspace}

\newcounter{bbx:relatedcount}
\newcounter{bbx:relatedtotal}

\def\ifrelatedloop{%
	\ifboolexpr{	test {\xifinlistcs{\strfield{entrykey}}{bbx:relatedloop}}
					or
					test {\xifinlistcs{\strfield{clonesourcekey}}{bbx:relatedloop}} }}

\newbibmacro*{begrelated}{\booltrue{bbx@inset}}
\newbibmacro*{endrelated}{\usebibmacro*{bbx:savehash}}
\newbibmacro*{begrelatedloop}{}
\newbibmacro*{endrelatedloop}{}

\newbibmacro*{related:init}{\csundef{bbx:relatedloop}}

\newbibmacro*{related}{%
	\ifboolexpr{	test {\iffieldundef{related}}
					or
					test {\ifrelatedloop} }
		{}
		{\usebibmacro{begrelated}%
		 \def\bbx@tempa{}%
		 \setcounter{bbx:relatedtotal}{0}%
		 \def\do##1{%
			\entrydata{##1}{%
				\ifrelatedloop
					{}
					{\stepcounter{bbx:relatedtotal}%
					 \gappto{\bbx@tempa}{##1,}}}}%
		 \docsvfield{related}%
		 \restorefield{related}{\bbx@tempa}%
		 \ifnumgreater{\value{bbx:relatedtotal}}{0}
			{\listcsxadd{bbx:relatedloop}{\strfield{entrykey}}%
			 \iffieldundef{clonesourcekey}
				{}
				{\listcsxadd{bbx:relatedloop}{\strfield{clonesourcekey}}}%
			 \setcounter{bbx:relatedcount}{0}%
			 \def\do{%
				\stepcounter{bbx:relatedcount}%
 				\ifnumgreater{\value{bbx:relatedcount}}{1}
					{\printtext{\relateddelim}}
					{}}%
			 \ifbibmacroundef{related:\strfield{relatedtype}}
				{\appto{\do}{\usebibmacro{related:default}}}
				{\appto{\do}{\usebibmacro*{related:\strfield{relatedtype}}}}%
			 \iffieldformatundef{related:\strfield{relatedtype}}
				{\def\bbx@tempa{related}}
				{\def\bbx@tempa{related:\strfield{relatedtype}}}%
			\iffieldformatundef{relatedstring:\strfield{relatedtype}}
				{\def\bbx@tempb{relatedstring:default}}
				{\def\bbx@tempb{relatedstring:\strfield{relatedtype}}}%
			 \printtext[\bbx@tempa]{%
				\usebibmacro{begrelatedloop}%
				\iffieldundef{relatedstring}
					{\ifboolexpr{	test {\ifnumgreater{\value{bbx:relatedtotal}}{1}}
									and
									test {\ifbibxstring{\thefield{relatedtype}s}} }
						{\printtext[\bbx@tempb]{%
						 \bibstring[\mkrelatedstring]{\thefield{relatedtype}s}}}
						{\iffieldbibstring{relatedtype}
							{\printtext[\bbx@tempb]{%
							 \bibstring[\mkrelatedstring]{\thefield{relatedtype}}}}
							{}}}
					{\iffieldbibstring{relatedstring}
						{\printtext[\bbx@tempb]{%
						 \bibstring[\mkrelatedstring]{\thefield{relatedstring}}}}
						{\printfield[\bbx@tempb]{relatedstring}}}%
				 \docsvfield{related}%
				 \usebibmacro{endrelatedloop}}}%
			{}%
		 \usebibmacro{endrelated}}}

\endinput