%
%   This is file "frenchlaw.bbx", which is part of the "frenchlaw" package
%   Copyright 2009--2025: Fora VERN -- ienissei (at) gmail (dot) com
% 
%   This work may be distributed and/or modified under the conditions of the
%   LaTeX Project Public License, either version 1.3 of this license or, at your
%   option, any later version.
%
%   The latest version of the license can be found at:
%      http://www.latex-project.org/lppl.txt
%   and version 1.3 or later is part of all distributions of LaTeX, 2005/12/01 or later.
% 
%   This work has the LPPL maintenance status "author-maintained".
%   This work consists of the files listed in the README file.
%

%	The associated documentation file <frenchlaw-bbx.tex> was produced from this code by simply stripping the double percent signs at the beginning of lines, transforming the code into a LaTeX file.


%% \begin{noprint}
\ProvidesFile{frenchlaw.bbx}%
	[2014/09/30 v.0.9. Bibliography style for French legal documents]
%% \end{noprint}

%	TODO » Définir une option pour la langue latine, qui reprendrait la langue courante?
%	Vérifier tous les \{\} (crochets vides) => Le \if est-il bien nécessaire partout? Possibilité de le supprimer en utilisant un \setunit*{} (étoilé) ??

%	TODO » Simplifier au maximum en ajoutant des \ifcitation et \ifbibliography pour éviter de tout reprendre dans le .cbx, au moins pour les cas compliqués (e.g. postnote dans la jurisprudence)

% TODO > Avec \fullcites, \clearfield / \cleaarname semble affecter toutes les références… voir si on peut trouver autre chose que des \clear... en utilisant des conditionnels pour imprimer les champs quand il faut

% TODO > Problème avec les collections (+ proceedings?), John DOE (ed.). Éditeur (alors que ce devrait être une virgule)


% =***======***======***======***======***======***======***======***======***======***=

% #####	BIBLIOGRAPHY OPTIONS	#####

%	Create boolean toggles
\newtoggle{bbx:isbn}
\newtoggle{bbx:url}
\newtoggle{bbx:doi}
\newtoggle{bbx:eprint}
\newtoggle{bbx:related}
\newtoggle{bbx:dashed}

%	Declare bibliography options
\DeclareBibliographyOption{isbn}[true]{%
	\settoggle{bbx:isbn}{#1}}
\DeclareBibliographyOption{url}[true]{%
	\settoggle{bbx:url}{#1}}
\DeclareBibliographyOption{doi}[true]{%
	\settoggle{bbx:doi}{#1}}
\DeclareBibliographyOption{eprint}[true]{%
	\settoggle{bbx:eprint}{#1}}
\DeclareBibliographyOption{related}[true]{%
	\settoggle{bbx:related}{#1}}
\DeclareBibliographyOption{dashed}[true]{%
	\settoggle{bbx:dashed}{#1}
	\iftoggle{bbx:dashed}{\ExecuteBibliographyOptions{pagetracker}}{}%
}

%	Execute bibliography options
\ExecuteBibliographyOptions{%
	isbn,doi,eprint,url,related,dashed,%
	sorting=nty,useeditor=true,usetranslator=false,maxnames=5,%
	language=auto,autolang=hyphen}% langhook=extras
\ExecuteBibliographyOptions[collection]{useeditor=false}
\ExecuteBibliographyOptions[reference,proceedings]{useauthor=false,useeditor=false}


% =***======***======***======***======***======***======***======***======***======***=

% #####	LANGUAGE FILES	#####

%	Load language files
\DeclareLanguageMapping{french}{frenchlaw-fr}
\DeclareLanguageMapping{english}{frenchlaw-en}
\DeclareLanguageMapping{british}{frenchlaw-en}

% Toggle French smartof properly
\settoggle{smartof}{false}


% =***======***======***======***======***======***======***======***======***======***=

% #####	PRESENTATION RULES #####


% ===== Field Formats	=====

%	Define aliases for bibliography drivers
\DeclareBibliographyAlias{review}{article}
\DeclareBibliographyAlias{periodical}{article}
\DeclareBibliographyAlias{suppperiodical}{article}
\DeclareBibliographyAlias{mvbook}{book}
\DeclareBibliographyAlias{bookinbook}{inbook}
\DeclareBibliographyAlias{suppbook}{inbook}
\DeclareBibliographyAlias{mvcollection}{collection}
\DeclareBibliographyAlias{suppcollection}{incollection}
\DeclareBibliographyAlias{mvproceedings}{proceedings}
\DeclareBibliographyAlias{mvreference}{reference}
\DeclareBibliographyAlias{suppreference}{inreference}
\DeclareBibliographyAlias{*}{misc}

%	Define a [plain] field format
\DeclareFieldAlias{plain}{noformat}

%	Define [roman] field format (lowercase roman numbers from integer)
\DeclareFieldFormat{roman}{\Rn{#1}}
\def\Rnfont{\scshape}

%	Define {title} fields
% TODO » \isdot à la fin de tous les titres (?)
\DeclareFieldFormat[bookinbook]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[reference]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[inreference]{title}{%
	\ifnameundef{author}
		{\mkbibemph{#1}}
		{\ifbibliography
			{\mkbibquote{#1}}
			{#1}}}
\DeclareFieldFormat[thesis]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[review]{title}{#1}
\DeclareFieldFormat[booklaunch]{title}{\mkbibquote{#1}}
\DeclareFieldFormat[article]{title}{\mkbibquote{#1}}
\DeclareFieldFormat[commentary]{title}{\mkbibquote{#1}}
\DeclareFieldFormat[legal]{title}{#1}
\DeclareFieldFormat[legislation]{title}{#1}
\DeclareFieldFormat[jurisdiction]{title}{#1}
\DeclareFieldFormat{titleaddon}{#1}
\DeclareFieldFormat{journaltitle}{\mkbibemph{#1}}
\DeclareFieldFormat{shortjournal}{\mkbibemph{#1}\isdot}
\DeclareFieldFormat[legislation]{shorttitle}{#1\isdot}

\DeclareFieldFormat{url}{<\,\url{#1}>}

% Define volume fields
\DeclareFieldFormat*{volume}{%
	\bibstring{volume}~\mkcomprange{#1}}

% Define number fields
\DeclareFieldFormat*{number}{%
	\iffieldnums{number}
		{\iffieldnum{number}
			{\bibstring{number}\addnbthinspace#1}
			{\bibstring{numbers}\addnbthinspace\mkcomprange{#1}}}
		{#1\isdot}}
% TODO » For adding a plural form, check with biber if the field contains a comma, then add a keyword or whatever
\DeclareFieldFormat[inreference]{number}{%
	\addnbthinspace\mkcomprange{#1}}
\DeclareFieldFormat[legal,legislation,jurisdiction]{number}{%
	\bibstring{number}\addnbthinspace\MakeLowercase{\scshape#1}}

% The <pages> field should only print the first page
% Except in CV mode, for which we print the page span
\DeclareFieldFormat[article,commentary,review]{pages}{%
	\mkfirstpage*{\bibstring{pages}#1}\psq}

\DeclareFieldFormat{noprefix}{%
	\let\psq\relax%
	\let\mkpageprefix\relax%
	\mkfirstpage*{#1}}

%\NumCheckSetup{\def\&{\psq\addspace\bibstring{and}\addspace\mkpageprefix}}
\DeclareRangeCommands*{\bibrangeslast}

\newrobustcmd{\bibrangeslast}{%
	\psq\addspace\bibstring{and}\addspace\bibstring{pages}}%
\newrobustcmd{\sq}{\addnbspace\bibstring{sequens}\xspace}%

\renewcommand{\bibrangessep}{%
	\ifthenelse{	\iffieldequalstr{langid}{french} \OR
		 			\iffieldundef{langid}	}
		{\psq\addcomma\addspace}
		{\addcomma\addspace}}

% Page, number, volume ranges should not be truncated under 1000
\setcounter{mincomprange}{1000}


% ===== Name Formats	=====

%	Use French formatting for all last names (language independent)
\iflanguage{french}
	{\protected\def\mkbibnamefamily#1{\textsc{\textnohyphenation{#1}}}}

% \renewbibmacro*{index:name}[5]{%
%   \usebibmacro{index:entry}{#1}{%
%   	\iffieldundef{usera}
%   		{\namepartfamily, \namepartgiven}
%   		{\thefield{usera}}%
%   	\actualoperator%
%   	\mkbibindexname{\textsc{#2}}{#3}{#4}{#5}}}

% TODO Vérifier que le \textsc soit bien au bon endroit / indexe-t-on les prénoms aussi?
\DeclareIndexNameFormat{default}{%
  \usebibmacro{index:name}
    {\bibindex}
    {\namepartfamily, \namepartgiven\actualoperator\textsc{\namepartfamily}}
    {\namepartgiven}
    {\namepartprefix}
    {\namepartsuffix}}
% \DeclareIndexNameFormat{default}{%
% 	\usebibmacro{index:name}{\bibindex}{#1@\textsc{#1}}{#3}{#5}{#7}}
% \DeclareIndexFieldFormat{default}{\lawindex{#1}}

\DeclareNameFormat{commentator}{%
	\ifrelatedloop
		{\usebibmacro{name:family-given}
			{\namepartfamily}
			{\namepartgiven}
			{\namepartprefix}
			{\namepartsuffix}}
		{\ifnum\value{uniquename}=0
			\usebibmacro{name:family}
				{\namepartfamily}
				{\namepartgiven}
				{\namepartprefix}
				{\namepartsuffix}%
		 \else
			\usebibmacro{name:given-family}
				{\namepartfamily}
				{\namepartgiveni}
				{\namepartprefix}
				{\namepartsuffix}%
		 \fi}}

\DeclareNameFormat{shortauthor}{%
	\usebibmacro{name:family}
			{\namepartfamily}
			{\namepartgiven}
			{\namepartprefix}
			{\namepartsuffix}}

%	Use last-name only for the first author in the entry.
\DeclareNameAlias{author}{family-given/given-family}
\DeclareNameAlias{editor}{family-given/given-family}
\DeclareNameAlias{translator}{family-given/given-family}
\DeclareNameAlias[commentary]{author}{commentator}
\DeclareNameAlias{byeditor}{labelname}

%\DeclareNameAlias[jurisdiction]{institution}{sortname}%	TODO	» Utilité?

%	TODO » NameFormat given-family if bbx:related -- insérer dans une commande \DeclareNameFormat{author}
% Utiliser \ifbibliography pour trier entre les auteurs alphabétiques et ceux dans l'ordre normal (?)


% ===== Punctuation Rules	=====

%	Redefine punctuation
\renewcommand*{\newunitpunct}{\addcomma\space}
\renewcommand*{\newblockpunct}{\addperiod\space}
\renewcommand*{\labelnamepunct}{\ifbibliography{\addperiod\space}{\addcomma\space}}% Add period when in bibliography, but add comma in fullcites
\renewcommand*{\subtitlepunct}{\addcolon\space}
\renewcommand*{\intitlepunct}{\addspace}
\renewcommand*{\relatedpunct}{\addsemicolon\addspace}

\renewcommand*{\relateddelim}{\addsemicolon\addspace}
\renewcommand*{\textcitedelim}{\addsemicolon\space}

%	TODO » Create commands, e.g. for commas or colons


% =***======***======***======***======***======***======***======***======***======***=

% #####	BIBLIOGRAPHY ENVIRONMENTS #####


% ===== Environments & Checks =====

\defbibenvironment{shortauthor}
	{\list
		{}
		{\setlength{\leftmargin}{\z@}%
		 \setlength{\parsep}{\baselineskip}}}
	{\endlist}
	{\item}

\defbibcheck{shortauthor}{%
	\ifnameundef{shortauthor}
		{\skipentry}
		{}}

\defbibenvironment{abbreviations}
	{\list
		{\xdef\currentjournal{\thefield{shortjournal}}%
		 \xdef\currenttitle{\thefield{shorttitle}}%
		 \ifx\currentjournal\lastjournal\else
			\printfield[plain]{shortjournal}%
			\global\xdef\lastjournal{\thefield{shortjournal}}%
		 \fi%
		 \ifx\currenttitle\lasttitle\else
		 	\printfield{shorttitle}% [plain] style prevents double \emph
		 	\global\xdef\lasttitle{\thefield{shorttitle}}%
		 \fi}
		{\setmaxlength{\labelwidth}{\shortjournalwidth}%
		 \setmaxlength{\labelwidth}{\shorttitlewidth}%
		 \setlength{\leftmargin}{\labelwidth}%
		 \setlength{\labelsep}{\biblabelsep}%
		 \addtolength{\leftmargin}{\labelsep}%
		 \setlength{\itemsep}{\bibitemsep}%
		 \setlength{\parsep}{\bibparsep}%
		 \raggedright%
		 \renewcommand*{\makelabel}[1]{\mkbibemph{##1\hss}}}}
	{\endlist}
	{\item}

%	TODO » Copier les defbibfilter et catégories ici
%	Set up a bibliography check that removes duplicate journal titles from the shortjournal list
\defbibcheck{abbreviations}{%
	\iffieldundef{shortjournal}
		{\ifthenelse{	\iffieldundef{shorttitle} \OR
						\ifentrytype{legislation} }
			{\skipentry}
			{\ifcsdef{\strfield{shorttitle}=\strfield{title}}
				{\skipentry}
				{\ifnameundef{shortauthor}
					{\savefieldcs{title}%
						{\strfield{shorttitle}=\strfield{title}}}
					{\skipentry}}}}
		{\iffieldundef{journaltitle}
			{\skipentry}
			{\ifcsdef{\strfield{shortjournal}=\strfield{journaltitle}}
				{\skipentry}
				{\savefieldcs{journaltitle}%
					{\strfield{shortjournal}=\strfield{journaltitle}}}}}}


% ===== Entry Sorting	=====

%	Sort entries by {name/institution} + year + day + month + title for generic bibliographies
\DeclareSortingTemplate{nty}{
	\sort{\field{presort}}
	\sort[final]{\field{sortkey}}
	\sort{\field{sortname}
		  \field{author}
		  \field{editor}
		  \field{translator}
		  \field{institution}}
	\sort{\field{collaborator}}
	\sort{\field{type}}
	\sort{\field{sorttitle}
		  \field{title}}
	\sort{\field{sortyear}
		  \field{year}}
	\sort{\field{month}}
	\sort{\field{day}}
	\sort{\field{volume}
		  \literal{0}}
}

% Sort entries by shortauthor for the shortauthor environemnt
\DeclareSortingTemplate{shortauthor}{
	\sort{\field{presort}}
	\sort[final]{\field{sortkey}}
	\sort{\field{labelname}
		  \literal{ZZ}}
	\sort{\field{sorttitle}
		  \field{title}}
	\sort{\field{sortyear}
		  \field{year}}
}

% Sort entries by shortjournal for the abbreviations environent
\DeclareSortingTemplate{abbreviations}{
	\sort{\field{presort}}
	\sort[final]{\field{sortkey}}
	\sort{\field{shortjournal}
		  \field{shorttitle}}
	\sort[direction=descending]{
		\field{year}}
	\sort{\field{journaltitle}
		  \field{title}}
}



% ===== Vertical Alignment	=====

\setlength{\bibitemsep}{0pt}
\setlength{\bibnamesep}{0pt}
\setlength{\bibinitsep}{0pt}
\setlength{\bibparsep}{0pt}

%	TODO » Utilité ? Alignement vertical ?
% \defbibheading{subbibliography}[\refname]{%
% 	\setlength{\beforesecskip}{2\baselineskip}
% 	\renewcommand*{\large}{\fontsize{14}{14.5}\selectfont}
% 	\section*{#1}%
% 	\if@twoside\markright{\MakeUppercase{#1}}\fi}

% \defbibheading{subbibintoc}[\refname]{%
% 	\setlength{\beforesecskip}{2\baselineskip}
% 	\renewcommand*{\large}{\fontsize{14}{14.5}\selectfont}
% 	\section*{#1}%
% 	\addcontentsline{toc}{section}{#1}%
% 	\if@twoside\markright{\MakeUppercase{#1}}\fi}


% =***======***======***======***======***======***======***======***======***======***=

% #####	CITATION PROCESSORS	#####

%	Set up a citation command for cross-references
% Fonction ??
% TODO: Supprime aussi le nom de la crossref s'il est différent du nom de l'auteur => Utilsier un authortype si besoin (et intégrer ça dans le code)
\DeclareCiteCommand{\bbx@crossref}
	{}
	{\ifthenelse{	\ifnameundef{labelname} \OR
					\ifnamesequal{labelname}{author} \OR
					\ifnamesequal{labelname}{editor} }
		{\printfield[title]{labeltitle}%
		 \setunit{\addspace}%
		 \printnames[labelname]{shortauthor}}
		{\printnames[labelname]{labelname}%
		 \newunit\newblock
		 \printfield[title]{labeltitle}}}
	{}
	{}


% =***======***======***======***======***======***======***======***======***======***=

% #####	BIBER PRE-PROCESSOR	#####

% Ajouter un remplacement de " (" par une espace isnécable (?)
% TODO > Ajouter une modifiation pour hyphenation english=american et latin=??

% Never inherit shorttitle fields
\DeclareDataInheritance{*}{*}
	{\noinherit{shorttitle}
	 \noinherit{shortauthor}}

% TODO » Foreach loop used in DeclareSourceMap (gorup them?)
\def\do#1{%
	\ifstrequal{shortauthor}{#1}
		{}
		{\ifcsundef{blx@csv@datamodel@names}
			{\csdef{blx@csv@datamodel@names}{#1}}
			{\csappto{blx@csv@datamodel@names}{,#1}}}}
\dolistcsloop{blx@datamodel@names}

%	Abbreviate first names that start with a sequence of consonants (Philip > Ph.)
% Format all names in .bib file as "Last, First and Last, First", as the comma is used to locate the first name
% TODO > Dans le code du prénom, essayer de parser les initiales des seconds prénoms (juste une lettre, juste avnat le groupe \Z etc.) et créer une option qui affiche soit la première initiale correctement abrégée, soit toutes les initiales du prénom (espace après la première initiale si plusieurs consonnes), peut-être avec un \delim... qui sera redéfini en \@gobble au besoin, pour supprimer les seconds prénoms. Et à appliquer en fonction de la langue
% Et option avec le prénom complet + initiale des prénoms suivants == refédinir ainsi le nom principal et faire comme précédemment pour les initiales
% OU: utiliser le même stratagème avec un truc un peu plus complexe, du genre: \first{Thomas} \second{Henry}, qui s'affichent ou non selon le cas ++ la même chose en initiales, et le nameformat choisit ce quo'n affiche dans tout ça
\DeclareStyleSourcemap{%
	\maps[datatype=bibtex]{%
		% Replace the initial of people's first names with the first consonnants of the name, as per the French typographic rules. Including composite given names (Jean-Christophe)
		% Requires name fields to be in the "Last, First" format
			%	Regex explanation:
				% (\A|\s+and\s+) -- Beginning of a name
				% ([a-z'\s]+)?\s* -- Prefix (von part), don't capture last space
				% (.+?)\,\s+ -- Family name + comma
				% (Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|(?:À|Â|Ä|Ç|É|È|Ê|Ë|Î|Ï|Ô|Ö|Ù|Û|Ü|Ÿ|Æ|Œ)|\w) -- Given name initials: several consonnants, or accented letter between braces (converted from TeX syntax), or any letter
				% (.+?) -- Rest of first given name, except compoud names
				% (?:(\-(?:Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|(?:À|Â|Ä|Ç|É|È|Ê|Ë|Î|Ï|Ô|Ö|Ù|Û|Ü|Ÿ|Æ|Œ)|\w))(.+?))? -- Same as above, but for the compound part of the first given name (Jean-Claude), if found
				% (?=\Z|\s+and\s+) -- End of a name
			% Old system (pre-2020):
				% match={\regexp{(,\s|-)\b(Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](l|r))}},%
				% replace={\regexp{$1\{\\relax\{\}$2\}}}]
		\if@french
		\map[foreach=\blx@csv@datamodel@names,overwrite=true]{%
		    \step[fieldsource=\regexp{$MAPLOOP},%
		        match=\regexp{(\A|\s+and\s+)([a-z'\s]+)?\s*(.+?)\,\s+(Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|(?:À|Â|Ä|Ç|É|È|Ê|Ë|Î|Ï|Ô|Ö|Ù|Û|Ü|Ÿ|Æ|Œ)|\w)(.+?)(?:(\-(?:Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|(?:À|Â|Ä|Ç|É|È|Ê|Ë|Î|Ï|Ô|Ö|Ù|Û|Ü|Ÿ|Æ|Œ)|\w))(.+?))?(?=\Z|\s+and\s+)},
		        replace=\regexp{$1 family=$3, prefix=$2, given=$4$5$6$7, given-i=\{$4$6\}}]
		    \step[fieldsource=\regexp{$MAPLOOP},
		        match=\regexp{(prefix=\,)},
		        replace=\regexp{}]
		    % Essayer de rajouter un \\bibnamedelima après le texte du préfixsi non vide et non apostrophe
		    % Essayer de gérer les initiales (option )
    }
    \fi
		% Replace dots and spaces in abbreviations with the proper macros
		\map[overwrite=true]{
			\step[fieldsource=shortjournal,%
				match={\regexp{\.\s}},
				replace={\regexp{\\adddotspace\x20}}]
			\step[fieldsource=shortjournal,%
				match={\regexp{\.}},
				replace={\regexp{\\adddot\x20}}]
			\step[fieldsource=shortjournal,%
				match={\regexp{([A-ZÉÈ\d])\s}},
				replace={\regexp{$1\\addabbrvspace\x20}}]
			\step[fieldsource=shortjournal,%
				match={\regexp{([A-ZÉÈ\d][A-ZÉÈ\d]+)}},
				replace={\regexp{\\acronym\{$1\}}}]
			\step[fieldsource=shorttitle,%
				match={\regexp{\.\s}},
				replace={\regexp{\\adddotspace\x20}}]
			\step[fieldsource=shorttitle,%
				match={\regexp{\.}},
				replace={\regexp{\\adddot\x20}}]
			\step[fieldsource=shortjournal,%
				match={\regexp{([A-ZÉÈ\d])\s}},
				replace={\regexp{$1\\addabbrvspace\x20}}]
			\step[fieldsource=shorttitle,%
				match={\regexp{([A-ZÉÈ\d][A-ZÉÈ\d]+)}},
				replace={\regexp{\\acronym\{$1\}}}]
		}
		%	Undo pre-processing of the \DH command
		\map[overwrite=true]{
			\step[fieldsource=series,%
				match={\regexp{Ð}},
				replace={\regexp{\\DH}}]
		}
		% When citing a collective/reference work, set the <editor> to <compiler> by default
		\map[overwrite=false]{%
			\pertype{mvbook}
			\pertype{collection}
			\pertype{proceedings}
			\pertype{reference}
			\pertype{incollection}
			\pertype{inproceedings}
			\pertype{inreference}
			\step[fieldset=editortype, fieldvalue={compiler}]
		}
		% 	Always print collected works (CW) first in bibliography
		\map[overwrite=true]{%
			\step[fieldsource=entrykey,
				match={\regexp{:CW}}, fieldset=sorttitle, fieldvalue={1}]
		}
		% 	Skip <location> field for university presses
		%	TODO » Ajouter un \if language = french, delete ", France"
		\map[overwrite=true]{%
			\step[fieldsource=publisher,%
				match={\regexp{(University|(U|u)niversité|(U|u)niversitaires)}},
				fieldset=location, null]
		}
		% When citing a <legislation> entry, define a gender field based on the first word of the <type> field.
		\map[overwrite=false]{%
			\pertype{legislation}
			\step[fieldsource=type,%
				match={\regexp{^(Code|Contrat|Décret(-loi)?|Préambule|Projet|Rapport|R(é|è)glement|Traité)}},
				fieldset=gender, fieldvalue={sm}]
			\step[fieldsource=type,%
				match={\regexp{^(Charte|Circulaire|Constitution|Convention|Coutume|Décision|Directive|Déclaration|Délibération|Loi|Norme|Note|Proposition|Protocole|Question|Recommandation|Réponse)}},
				fieldset=gender, fieldvalue={sf}]
			\step[fieldsource=type,%
				match={\regexp{^(Accord|Acte|Annexe|Arrêté|Avis|(E|É)dit|Information|Ordonnance|Usage)}},
				fieldset=gender, fieldvalue={sn}]
		}
		% Tweak the sorting of <legislation> entries without using a different sortscheme. Used for saving TeX memory on large .bib files
		\map[overwrite=true]{%
			\pertype{legislation}
			\step[fieldsource=type,
				match={\regexp{^(\w+)}}, fieldset=sortname, fieldvalue={$1}]
			\step[fieldsource=date, fieldset=sorttitle, origfieldval]
		}
		% When a <jurisdiction> entry has a <series> field, replace explicit roman numerals with small-caps roman numerals
		\map[overwrite=true]{%
			\pertype{jurisdiction}
			% Convert part to small-caps
			\step[fieldsource=series,%
				match={\regexp{\.(I|II)\.}},
				replace={\regexp{\.\\textsc{\L$1}\.}}]
		}
		% Tweak the sorting of <jurisdiction>, <legislation> entries without using a different sortscheme. Used for saving TeX memory on large .bib files
		\map[overwrite=true]{%
			\pertype{jurisdiction}
			\step[fieldsource=institution,%
				match={\regexp{^\\\w+\s(\w+)}},
				fieldset=sortname, fieldvalue={\regexp{$1\x20}}]
			\step[fieldsource=date, fieldset=sortname, origfieldval, append]
		}
		% When citing a judicial decision or commentary with a <related> field, make sure both entries are in the bibliography.
		\map[overwrite=false]{%
			\pertype{commentary}
			\pertype{jurisdiction}
			\pertype{legislation}
			\step[fieldset=relatedoptions, fieldvalue={skipbiblist=false}]
		}
		% When there are several pages, use a special delimiter for the last one
		\map[overwrite=true]{%
			\step[fieldsource=pages,%
				match={\regexp{,(?!.*,)}},
				replace={\regexp{ \\bibrangeslast }}]
		}
		% Overwrite <abstract> and <annotation> fields, to prevent overflowing TeX capacity.
		\map[overwrite=true]{%
			\step[fieldset=abstract, fieldvalue={}]
			\step[fieldset=annotation, fieldvalue={}]
		}
}}%

% TODO » Problèmes:
% Biber ne parse pas les lettres accentuées données comme initiales. Le regexp en exclut une partie, mais pas celles dans les noms composés:
% Charles-Édouard ou Étienne-Marie perdent leur accent (uniquement si initiales).

% Cf. http://tex.stackexchange.com/a/423534/10119

% Ajouter les lettres manuellement, séparées par |, avant le \w (qui n'a plus besoin de lookahead):
% ÁÀÂÄÃÅÆÇŠÉÈÊËÍÌÎÏÐÑÓÒÔÖÕØÚÙÛÜÝŸŒ

% \def\do#1{%
%   \ifcsundef{blx@csv@datamodel@names}
%     {\csdef{blx@csv@datamodel@names}{#1}}
%     {\csappto{blx@csv@datamodel@names}{,#1}}}
% \dolistcsloop{blx@datamodel@names}

% \DeclareSourcemap{
%   \maps[datatype=bibtex]{
%     \map[foreach=\blx@csv@datamodel@names]{
%       \step[fieldsource=\regexp{$MAPLOOP}, 
%             match=\regexp{(\A|\s+and\s+)([a-z'\s]+)?\s*(.+?)\,\s+(Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|\w(?=\w+-))([\w\s]+)(?:(-)(Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|\w)([\w\s]+))?(?=\Z|\s+and\s+)},
%             replace=\regexp{$1 family=$3, prefix=$2, given=$4$5$6$7$8, given-i=\{$4$6$7\}}]
%       \step[fieldsource=\regexp{$MAPLOOP},
%       		match=\regexp{(prefix=\,)},
%             replace=\regexp{}]
%     }
%   }
% }

% WORKS:
% match=\regexp{(\A|\s+and\s+)([a-z'\s]+)?\s*(.+?)\,\s+(Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|\w(?=\w+-))([\w\s]+)(?:(-)(Chr?|Th|Ph|[B-DF-HJ-NP-TV-XZ](?:l|r)|\w)([\w\s]+))?(?=\Z|\s+and\s+)},


% =***======***======***======***======***======***======***======***======***======***=

% #####	BIBLIOGRAPHY DRIVERS	#####

% Noter dans la doc quel est le type de chaque champ, e.g. <institution> est une liste, donc pour les cotutelles, séparer par "and"

%	Create hooks for bibliography drivers
\newbibmacro*{begentry}{}
\newbibmacro*{finentry}{\finentry}

%	Define a driver for <article> entries
\DeclareBibliographyDriver{article}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\ifentrytype{review}
		{\printtext{\bibstring{reviewof}}%
		 \addcolon\addspace}
		{}%
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	% \newunit\newblock
	% \usebibmacro{bytranslator+others}%
	% \newunit\newblock
	% \printfield{note}%
	\newunit\newblock
	\usebibmacro{journal+issue+date}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\iftoggle{bbx:related}
		{\setunit{\relateddelim}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <book> entries
\DeclareBibliographyDriver{book}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/editor+others/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+title}%
	% \newunit%
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{edition}%
	\usebibmacro{byeditor+others}%
	% \newunit\newblock
	% \printfield{note}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	% \newunit\newblock
	% \usebibmacro{cite:postnote}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <collection> entries
\DeclareBibliographyDriver{collection}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/editor+others/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+booktitle}%
	% \newunit%
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{edition}%
	\usebibmacro{byeditor+others}%
	% \newunit\newblock
	% \printfield{note}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	% \newunit\newblock
	% \usebibmacro{cite:postnote}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <proceedings> entries
\DeclareBibliographyDriver{proceedings}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/editor+others/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{event+venue+date}%
	%\setunit{\newblockpunct}\newblock
	% \usebibmacro{edition}%
	\newunit\newblock% [= Instead of printing the edition]
	\usebibmacro{byeditor+others}%
	% \newunit\newblock
	% \printfield{note}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	% \newunit\newblock
	% \usebibmacro{cite:postnote}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <reference> entries
\DeclareBibliographyDriver{reference}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/editor+others/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{maintitle+title}%
	% \newunit%
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{bycompiler}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{edition}%
	\usebibmacro{byeditor+others}%
	% \newunit\newblock
	% \printfield{note}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	% \newunit\newblock
	% \usebibmacro{cite:postnote}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <inbook> entries
\DeclareBibliographyDriver{inbook}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	\iffieldundef{crossref}
		{\newunit\newblock
		 \usebibmacro{in:}%
		 \usebibmacro{maintitle+booktitle}%
		 \newunit\newblock
		 \usebibmacro{bybookauthor}%
		 \setunit{\newblockpunct}\newblock
		 \usebibmacro{edition}%
		 \usebibmacro{byeditor+others}%
		 % \newunit\newblock
		 % \printfield{note}%
		 \setunit{\newblockpunct}\newblock
		 \printfield{booktitleaddon}%
		 \setunit{\newblockpunct}\newblock
		 \usebibmacro{publisher+location+date}%
		 \setunit{\newblockpunct}\newblock
		 \usebibmacro{pubstate+addendum}%
		 \newunit\newblock
		 \usebibmacro{isbn+doi+eprint+url}}
		{\newunit\newblock
		 \usebibmacro{see:}%
		 \bbx@crossref{\thefield{crossref}}}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\newunit\newblock
	\usebibmacro{chapter+pages}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	% \newunit\newblock
	% \usebibmacro{cite:postnote}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <incollection> entries
\DeclareBibliographyDriver{incollection}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	\iffieldundef{crossref}%
		{\newunit
		 \usebibmacro{in:}%
		 \usebibmacro{maintitle+booktitle}%
		 \newunit\newblock
		 \usebibmacro{bybookauthor}%
		 \setunit{\newblockpunct}\newblock
		 \usebibmacro{edition}%
		 \usebibmacro{byeditor+others}%
		 % \newunit\newblock
		 % \printfield{note}%
		 \setunit{\newblockpunct}\newblock
		 \printfield{booktitleaddon}%
		 \setunit{\newblockpunct}\newblock
		 \usebibmacro{publisher+location+date}}
		{\newunit\newblock
		 \usebibmacro{see:}%
		 \bbx@crossref{\thefield{crossref}}}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\newunit\newblock
	\usebibmacro{chapter+pages}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	% \newunit\newblock
	% \usebibmacro{cite:postnote}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}
		 \newblock\usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <inproceedings> entries
\DeclareBibliographyDriver{inproceedings}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	\iffieldundef{crossref}%
		{\newunit
		 \usebibmacro{in:}%
		 \usebibmacro{maintitle+booktitle}%
		 \newunit\newblock
		 \usebibmacro{event+venue+date}%
		 %\setunit{\newblockpunct}\newblock
		 % \usebibmacro{edition}%
		 \newunit\newblock% [= Instead of printing the edition]
		 \usebibmacro{byeditor+others}%
		 % \newunit\newblock
		 % \printfield{note}%
		 \setunit{\newblockpunct}\newblock
		 \printfield{booktitleaddon}%
		 \setunit{\newblockpunct}\newblock
		 \usebibmacro{publisher+location+date}}
		{\newunit\newblock
		 \usebibmacro{see:}%
		 \bbx@crossref{\thefield{crossref}}}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{volume+part}%
	\newunit\newblock
	\usebibmacro{chapter+pages}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	% \newunit\newblock
	% \usebibmacro{cite:postnote}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <inreference> entries
\DeclareBibliographyDriver{inreference}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	%		Apply different style to periodical entries (Répertoire Dalloz, Jurisclasseur) and to texts from a reference work
	\iffieldundef{journal}%
		% Periodical entries (Répertoire Dalloz, Jurisclasseur)
		{\printfield{title}%
		 % \newunit
		 % \printlist{language}%
		 \newunit\newblock
		 \usebibmacro{byauthor}
		 \iffieldundef{crossref}%
			{\newunit
			 \usebibmacro{in:}%
			 \usebibmacro{maintitle+booktitle}%
			 \ifdefined\bpl@osurname
				\ifnum\value{nonplauthors}>0
					\setunit{\nopunct}
					\usebibmacro{author/translator+others}%
			 \fi\fi
			 \newunit\newblock
			 \usebibmacro{bybookauthor}%
			 \setunit{\newblockpunct}\newblock
			 \usebibmacro{edition}%
			 \usebibmacro{byeditor+others}%
			 % \newunit\newblock\
			 % \printfield{note}%
			 \setunit{\newblockpunct}\newblock
			 \usebibmacro{publisher+location+date}}
			{\newunit\newblock
			 \usebibmacro{see:}%
			 \bbx@crossref{\thefield{crossref}}}%
		 \setunit{\bibpagespunct}\newblock
		 \usebibmacro{volume+part}%
		 \newunit\newblock
		 \usebibmacro{chapter+pages}%
		 \setunit{\newblockpunct}\newblock
		 \usebibmacro{pubstate+addendum}%
		 \newunit\newblock
		 \usebibmacro{isbn+doi+eprint+url}%
		 \setunit{\bibpagerefpunct}\newblock
		 \usebibmacro{pageref}%
		 \newunit\newblock
		 \usebibmacro{cite:postnote}%
		 \iftoggle{bbx:related}
			{\setunit{\relatedpunct}\newblock
			 \usebibmacro{related:init}%
			 \usebibmacro{related}}
			{}}
		% Extracts from reference works
		{\printfield{title}%
		 \setunit{\nopunct\addspace}
		 \printtext[parens]{\usebibmacro{date}}%
		 \newunit\newblock
		 \usebibmacro{in:}%
		 \iffieldundef{shortjournal}
			{\iffieldundef{crossref}
				{\usebibmacro{maintitle+booktitle}}
				{\bbx@crossref{\thefield{crossref}}}}
			{\printfield{shortjournal}}%
		 \newunit\newblock
		 \iffieldundef{number}
			{}
			{\bibstring{\thefield{pagination}}%
			 \printfield{number}%
			 \setunit{\addcolon\addspace}}}%
	\usebibmacro{finentry}}

%	Define a driver for <thesis> entries
\DeclareBibliographyDriver{thesis}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\newunit\newblock
	\iflistundef{publisher}
		{\printfield{type}%
		 \setunit{\addcomma\addspace}\newblock}
		{\setunit{\newblockpunct}\newblock
		 \usebibmacro{edition}%
		 \usebibmacro{byeditor+others}%
		 \setunit{\newblockpunct}\newblock}%
	% \newunit\newblock
	% \printfield{note}%
	\usebibmacro{publisher+location+date}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pagetotal/volumes}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <unpublished> entries
\DeclareBibliographyDriver{unpublished}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author}%
		\setunit{\labelnamepunct}\newblock
	\fi%
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{event+venue+date}%
	\newunit\newblock
	\usebibmacro{byeditor+others}%
	\setunit{\newblockpunct}%
	\printfield{note}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
	{}%
	\usebibmacro{finentry}}

%	Define a driver for <booklaunch> entries
\DeclareBibliographyDriver{booklaunch}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author}%
		\setunit{\labelnamepunct}\newblock
	\fi%
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{event+venue+date}%
	\newunit\newblock
	\usebibmacro{byeditor+others}%
	\setunit{\newblockpunct}%
	\printfield{note}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
	{}%
	\usebibmacro{finentry}}

%	Define a driver for <misc> entries
\DeclareBibliographyDriver{misc}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	% In CV mode, additional author names come after the title
	\ifdefined\bpl@osurname\else
		\usebibmacro{author/editor+others/translator+others}\fi%
	\setunit{\labelnamepunct}\newblock
	\usebibmacro{title}%
	% \newunit
	% \printlist{language}%
	\ifdefined\bpl@osurname
		\ifnum\value{nonplauthors}>0
			\setunit{\nopunct}
			\usebibmacro{author/translator+others}%
	\fi\fi
	\newunit\newblock
	\usebibmacro{byauthor}%
	\newunit\newblock
	\usebibmacro{byeditor+others}%
	\setunit{\newblockpunct}\newblock
	\printfield{howpublished}%
	\newunit\newblock
	\printfield{type}%
	\newunit
	\printfield{version}%
	\setunit{\newblockpunct}
	\printfield{note}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{publisher+location+date}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}%
	\setunit{\bibpagerefpunct}\newblock
	\usebibmacro{pageref}%
	\iftoggle{bbx:related}
		{\setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driveer for <legal> entries
\DeclareBibliographyDriver{legal}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\printlist{institution}%
	\newunit
	\iffieldundef{type}
		{}
		{\midsentence\printfield{type}\isdot%
		 \setunit{\addnbspace}}%
	\iffieldundef{number}
		{}
		{\printfield{number}%
		 \setunit{\addspace}}%
	\iffieldundef{series}
		{}
		{\newunit\newblock
		 \printfield{series}}%
	\iflistundef{location}
		{\setunit{\addspace}
		 \ifthenelse{\iffieldundef{day}\AND\iffieldundef{month}\AND\iffieldundef{year}}
			{}
			{\iffieldundef{day}
				{\bibstring{fromyear}%
				 \clearfield{month}}
				{\iffieldundef{endday}
					{\bibstring{fromdate}}
					{\bibstring{fromdates}}}%
			 \setunit{\addspace}
			 \usebibmacro{date}%
			 \setunit{\addspace}}}
		{}%
	\newunit\newblock
	\printfield{pages}%
	\newunit
	\printnames[labelname]{author}%
	\newunit
	\printfield{title}%
	\newunit\newblock
	\usebibmacro{cite:postnote}%
	% Primary citations and references print the series and commentaries
	\iftoggle{bbx:related}
		{ % \newunit\newblock
		 % \printfield{note}%
		 \setunit{\relatedpunct}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driveer for <legislation> entries
% TODO » British acts + Find a way to add which country's code it is when writing for a different audience (different entries? biber overriding?)
% TODO > utiliser pagination pour insérer art., §, s., etc. -- si prenote est vide --
\DeclareBibliographyDriver{legislation}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\iffieldundef{type}
		{}
		{\printfield{type}%
		 \setunit{\addnbspace}}%
	\iflistundef{institution}
		{}
		{\printtext[parens]{\printlist{institution}}
		 \setunit{\addspace}}%
	\iffieldundef{number}
		{}
		{\printfield{number}%
		 \setunit{\addspace}}%
	\iflistundef{location}
		{\ifthenelse{\iffieldundef{day}\AND\iffieldundef{month}\AND\iffieldundef{year}}
			{}
			{\iffieldundef{day}
				{\bibstring{fromyear}%
				 \clearfield{month}}
				{\iffieldundef{endday}
					{\bibstring{fromdate}}
					{\bibstring{fromdates}}}%
			 \setunit{\addspace}
			 \usebibmacro{date}%
			 \setunit{\addspace}}}
		{}%
	\printfield{title}%
	\iflistundef{location}
		{}
		{\setunit{\addspace}
		 \bibstring{signedat}%
		 \setunit{\addspace}
		 \printlist{location}%
		 \setunit{\addspace}
		 \ifthenelse{\iffieldundef{day}\AND\iffieldundef{month}\AND\iffieldundef{year}}
			{}
			{\bibstring{ondate}%
			 \setunit{\addspace}
			 \usebibmacro{date}%
			 \setunit{\addspace}}}%
	% Primary citations and references print the series and commentaries
	\iftoggle{bbx:related}
		{\newunit\newblock
		 \printfield{series}%
		 % \newunit\newblock
		 % \printfield{note}%
		 \setunit{\addspace}\newblock
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <jurisdiction> entries
\DeclareBibliographyDriver{jurisdiction}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\printlist{institution}%
	\ifkeyword{CEDH}
		% Define ECHR case citations
		{\newunit\newblock
		 \printfield{title}%
		 \iffieldundef{type}
		 	{}
			{\setunit{\addspace}
		 	 \printtext[parens]{\printfield{type}}}%
		 \newunit\newblock
		 \usebibmacro{date}%
		 \iffieldundef{number}
		 	{}
		 	{\newunit\newblock
		 	 \printfield{number}}}%
		{\ifthenelse{	\ifkeyword{CC}\OR\ifkeyword{CConst} }
			% Define CJEU and Constitutional Court case citations
			{\newunit\newblock
			 \printfield{type}%
			 \setunit{\addcomma\addspace}
			 \printfield{number}% TODO » Mettre au pluriel via un champ inséré par biber en présence d'un "et" (?) ou voir si on peut rechercher dans la chaîne "number" directement (string maniputation sous latex)
			 \newunit\newblock
			 \usebibmacro{date}%
			 \iffieldundef{title}
			 	{}
			 	{\newunit\newblock
			 	 \printfield{title}}}%
			{\ifkeyword{UK}
			 % Define UK case law citation (basic support)
				% Use <title> and <date> (if not included in report reference)
				% Use <series> to add the full report reference on first citation
				{\newunit
				 \printfield{title}%
				 \setunit{\addspace}
				 \iffieldundef{year}
				 	{}
				 	{\printtext[parens]{\usebibmacro{date}}}}
				% Define generic case law citation (French)
				{\newunit
				 \printfield{type}%
				 \newunit
				 \usebibmacro{date}%
				 \iffieldundef{title}
				 	{}
				 	{\newunit
					 \printfield{title}}%
				 \iffieldundef{number}
				 	{}
				 	{\newunit
				 	 \printfield{number}}}}}%
	\newunit\newblock
	\usebibmacro{cite:postnote}%
	% Primary citations and references print the series and commentaries
	\iftoggle{bbx:related}
		{\ifkeyword{UK}
				{\setunit{\addcomma\addspace}\newblock}
				{\setunit{\addcolon\addspace}\newblock}%
		 \iffieldundef{series}
			{}
			{\printfield{series}%
			 \setunit*{\relateddelim}\newblock}%
		 \usebibmacro{related:init}%
		 \usebibmacro{related}}
		{}%
	\usebibmacro{finentry}}

%	Define a driver for <commentary> entries
\DeclareBibliographyDriver{commentary}{%
	\usebibmacro{bibindex}%
	\usebibmacro{begentry}%
	\ifrelatedloop
		% Long citation for stand-alone references (in citations or bibliography)
		{\ifdefined\bpl@osurname
			\usebibmacro{bpl:marginyear}%
			\printfield[plain]{title}%
			\setunit*{\addcolon\addspace}\newblock
			\printfield[title]{titleaddon}%
			\addhighpenspace%
			\mkbibparens{\printfield{type}\unspace}%
			\if@british\iffieldundef{origtitle}
				{}
				{\setunit{\addspace}
				 \printfield{origtitle}}%
			\fi
		 \else
			\usebibmacro{author}%
			\setunit{\labelnamepunct}\newblock
		  \usebibmacro{title}%
		 \fi
		 % \ifdefined\bpl@osurname
			% \setunit*{\nopunct}%
			% \usebibmacro{author}\fi%
		 \newunit\newblock
		 \usebibmacro{journal+issue+date}%
		 \ifdefined\bpl@osurname\else
			 \newunit\newblock
			 \printfield{type}%
			 \setunit{\addspace}
			 \bibstring{under}%
			 \setunit{\addspace}
				\settoggle{bbx:related}{false}%
				\usebibmacro{related:init}%
				\usebibmacro{related}
			\fi}
		% Short citation, after the case citation (in citations or bibliography)
		%	TODO » Inverser l'ordre: Journal + Type + Author (ne pas utiliser Title)
		{\ifdefined\bpl@osurname
			\usebibmacro{bpl:marginyear}%
			\printfield[plain]{title}%
			\setunit*{\addcolon\addspace}\newblock
			\printfield[title]{titleaddon}%
			\addhighpenspace%
			\mkbibparens{\printfield{type}\unspace}%
		 \else
			\printfield{type}%
			% Don't allow line breaks between "n. AUTHOR" in footnotes -- be a bit more tolerant in bibliographies
			\ifbibliography
			 	{\setunit{\addabbrvspace}}
			 	{\setunit{\addnbspace}}%
			\usebibmacro{author}%
		 \fi%
		 \newunit\newblock
		 \usebibmacro{journal+issue+date}}%
	\setunit{\newblockpunct}\newblock
	\usebibmacro{pubstate+addendum}%
	\newunit\newblock
	\usebibmacro{isbn+doi+eprint+url}
	\ifdefined\bpl@osurname
		\settoggle{bbx:related}{false}%
		\usebibmacro{related:init}%
		\usebibmacro{related}%
	\fi%
	\usebibmacro{finentry}}

%	Define a driver for <shortjournal> abreviations
\DeclareBibliographyDriver{abbreviations}{%
	\iffieldundef{shortjournal}
		{\iffieldundef{type}
			{}
			{\printfield{type}%
			 \setunit{\addnbspace}}%
		 \printfield[plain]{title}}
		{\printfield[plain]{journaltitle}}}

\DeclareBibliographyDriver{shortauthor}{%
	\usedriver
		{\clearfield{crossref}%
		 \clearfield{series}}
		{\thefield{entrytype}}%
	\newunit
	\printtext{\bibstring{citedas}}%
	\setunit{\addspace}
	\ifuseauthor
		{\printnames{shortauthor}%
		 \newunit
		 \printfield{shorttitle}}
		{\printfield{shorttitle}%
		 \setunit{\addnbspace}
		 \printnames{shortauthor}}%
	\usebibmacro{finentry}}

% #####	CUSTOM BIBLIOGRAPHY MACROS	#####

\renewbibmacro*{in:}{%
	\bibstring[\mkbibemph]{in}%
	\setunit{\addspace}}

\newbibmacro*{see:}{%
	\bibstring{see}\space}

\newbibmacro*{relax:}{%
	\bibstring{relax}%
	\setunit{\addspace}}

%	Create a macro for collection/proceedings editors
\newbibmacro*{compiler}{%
	\ifthenelse{	\iffieldequalstr{editortype}{compiler}\AND\NOT
								\ifnameundef{editor}}
		{\printnames[labelname]{editor}%
		 \clearname{editor}
		 \setunit{\addspace\nolinebreak[3]}
		 %	TODO » Ne marche pas, toujours singulier
		 \ifthenelse{	\value{editor}=1 }
			{\printtext[parens]{\bibstring{compiler}}}
			{\printtext[parens]{\bibstring{compilers}}}%
		 \newunit\newblock}%
		{}}

%	Create a macro for multi-volume book editors
\newbibmacro*{bycompiler}{%
	\ifthenelse{\iffieldequalstr{editortype}{compiler}\AND\NOT\ifnameundef{editor}}
		{\printtext{\bibstring{bycompiler}}
		 \setunit{\addspace}
		 \printnames[labelname]{editor}%
		 \clearname{editor}}
		{}}

%	Biblatex.def forgot to format the by-bookauthor properly
\renewbibmacro*{bybookauthor}{%
	\ifnamesequal{author}{bookauthor}
		{}
		{\printnames[byauthor]{bookauthor}%
		 \setunit*{\newunitpunct}}}

\newbibmacro*{edition}{%
	\iffieldundef{edition}
		{\ifnameundef{editor}
		 	{\addperiod}% Mettre un point avant le premier éditeur, traducteur, etc.  -- Pas implémenté en anglais, car la bibstring ne s'y prête pas
		 	{\ifthenelse{	\iffieldequalstr{langid}{french} \OR
		 					\iffieldundef{langid}	}
			 	{\bibstring{edition}%
				 \setunit{\addspace}}
				{}}}
		{\printfield{edition}%
		 \newunit\newblock}}

%	Create macros for printing title elements
\newbibmacro*{maintitle+title}{%
	% Ne pas imprimer le titleaddon du {mvbook}, etc. dans une autre entrée
	\clearfield{maintitleaddon}%
	\usebibmacro{title}%
	\iffieldundef{maintitle}
		{}
		{\newunit\newblock
		 \usebibmacro{in:}%
		 \usebibmacro{compiler}%
		 \usebibmacro{maintitle}}}

\newbibmacro*{maintitle+booktitle}{%
	\ifdefined\bpl@osurname
		\ifthenelse{ \ifentrytype{incollection} \OR
								 \ifentrytype{inproceedings} }
			{}
			{\usebibmacro{bpl:marginyear}%
			 \setunit{\addspace}}%
	\fi
	\iffieldsequal{maintitle}{booktitle}
		{\clearfield{maintitle}%
		 \clearfield{mainsubtitle}%
		 \clearfield{maintitleaddon}}
		{\iffieldundef{maintitle}
			{}
			{\usebibmacro{maintitle}%
			 \setunit{\addcolon\addspace}}}%
	\usebibmacro{booktitle}%
	\newunit\newblock
	\usebibmacro{compiler}}

\renewbibmacro*{title}{%
	\ifdefined\bpl@osurname
	\usebibmacro{bpl:marginyear}%
	\fi
	\iffieldundef{title}
		{}
		{\printtext[title]{%
			\printfield[titlecase]{title}%
			\setunit{\subtitlepunct}%
			\printfield[titlecase]{subtitle}}%
		 \ifentrytype{commentary}
			{\newunit\newblock}
			{\setunit{\newblockpunct}}}%
	\printfield{titleaddon}%
	\ifdefined\bpl@osurname
		\if@british\iffieldundef{origtitle}
			{}
			{\setunit{\nopunct\addspace}
			 \printfield{origtitle}%
			 \addcomma\addspace}%
		\fi\fi}

\renewbibmacro*{booktitle}{%
	\iffieldundef{booktitle}
		{}
		{\printtext[booktitle]{%
			\printfield[titlecase]{booktitle}%
			\setunit{\subtitlepunct}%
			\printfield[titlecase]{booksubtitle}}%
		 \setunit{\newblockpunct}}}

%	Create a macro for journal titles + citation in French and English
%	TODO » Vérifier et corriger le bug quand un titre d'article (ou ouvrage?) se termine par un ... (et autres signes?). Ajouter un \isdot (?) ou préciser d'ajouter \@ dans le fichier .bib
\newbibmacro*{journal+issue+date}{%
	% When writing in English,  use full journal name instead of abbreviation
	%	TODO Improve… test whether english laguage + paper NOT in English
	\if@french\else
		\iffieldequalstr{langid}{french}
			{\clearfield{shortjournal}}
			{}%
	\fi
	\iffieldequalstr{langid}{english}
		%	For english language journals, print volume first
		{\printfield[plain]{volume}%
		 \iffieldsequal{year}{volume}
			 {\clearfield{year}}
			 {}%
		 \setunit{\addspace}}
		{}%
	\iffieldundef{shortjournal}
		{\usebibmacro{journal}}
		{\printfield[journaltitle]{shortjournal}\isdot}%
	\newunit\newblock
	% \printfield{series}%
	% \newunit
	\ifthenelse{	\iffieldequalstr{langid}{french} \OR
					\iffieldundef{langid} \AND\NOT
					\iffieldundef{part}	}
		%	For French language entries that have a <part> field
		% Ex: JCP 1950, I, 12345 -- JCP 2015, chron., 123
		{\newunit%
		 \printfield{year}%
		 \iffieldnum{part}
			{\setunit{\adddot}
			 \printfield[roman]{part}%
			 \setunit{\adddot}}
			{\newunit
			 \printfield[plain]{part}%
			 \isdot\newunit}%
			\iffieldundef{number}
			 	{\printfield[noprefix]{pages}}
			 	{\printfield[plain]{number}}}
	% End of the specifically French part
	%	For entries that are either not in French or have no <part> field
		{\ifthenelse{	\iffieldundef{number} \AND
						\iffieldundef{volume} \AND
						\iffieldundef{month} }
			%	If there is no <volume>, <number> or <month> defined, use short reference
			% Ex: RTD civ. 2010.123
			{\iffieldundef{pages}
				{}
				{\setunit{\nopunct\addabbrvspace}}%
			 \printfield{year}%
			 \setunit{\adddot}
			 \printfield[noprefix]{pages}%
			 \clearfield{pages}%
			 \clearfield{issue}}
			%	If a <volume>, <number> or <month> is specified
			{\ifthenelse{	\iffieldequalstr{langid}{english} \AND\NOT
								\iffieldundef{volume} }
				% TODO > prévoir quelque chose pour le cas où l'année et le volume sont identiques (cf. styles de citation)
				%	For english language journals, print date at the end
				% Ex: 123 Harv. L.J. 12 (2015)
				{\setunit{\nopunct\addabbrvspace}
				 \printfield[noprefix]{pages}%
				 \ifthenelse{	\iffieldundef{year} \AND
											\iffieldundef{number} \AND
											\iffieldundef{issue} }
					{}
					{\iffieldundef{pages}
						{\setunit*{\addspace}
						 \printtext[parens]{%
							\usebibmacro{date}}%
						 \newunit
						 \printfield{number}}
						{\setunit*{\addspace}
						 \printtext[parens]{%
							\usebibmacro{date}%
							\iffieldundef{number}
								{}
								{/\printfield[plain]{number}}}}}%
					 \newunit
					 \usebibmacro{issue}}
					%	For all other languages, use verbose style reference
					% Ex: Gaz. Pal., 5 janv. 2015, n°123, p. 123
					% --- Arch. phil. dr., 2015/4, n°123, p. 123
					% --- Past and Present, 2015, n°123, p. 123
				{\usebibmacro{date}%
				 \newunit
				 \printfield{volume}%
				 \newunit
				 \ifthenelse{	\iffieldundef{pages} \AND
											\iffieldundef{url} \AND
											\iffieldundef{pubstate} }
					{\printfield[plain]{number}}%
					{\printfield{number}}
				 \ifthenelse{	\iffieldundef{issuetitle} \AND \ifnameundef{editor}	}
					 {}
					{\setunit{\addcolon\addspace}
					 \usebibmacro{issue}%
					 \setunit{\addcomma\addspace}
					 \usebibmacro{byeditor}}%
				 \newunit\newblock
				 \printfield{pages}}}}%
	\newunit
	\printfield{doi}
	\newunit
	\printfield{eid}}

%	Create a macro for event venues + dates
\newbibmacro*{event+venue+date}{%
	\printfield{eventtitle}%
	\setunit{\addspace}
	\printfield{eventtitleaddon}%
	\ifthenelse{	\iffieldundef{eventyear} \OR
					\iffieldundef{eventmonth} \OR
					\iffieldundef{eventday} }
		{}
		{\midsentence%
		 \iffieldundef{eventendday}
			{\ifentrytype{booklaunch}
				{\newunit
				 \bibstring{ondate}}
				{\bibstring{fromdate}}}
			{\bibstring{fromdates}}%
		 \setunit{\addspace}%
		 \printeventdate}
	\setunit{\addspace}
	\iffieldundef{venue}
		{}
		{\printtext[parens]{%
			\printfield{venue}%
			\newunit\newblock
			\usebibmacro{organization}}}}

%	Create macros for publication information
\newbibmacro*{publisher+location+date}{%
	% If parent entry defines an end date and current entry doesn't, clear it.
	\iffieldxref{endyear}
		{\clearfield{endyear}}
		{}%
	\printlist{location}%
	\setunit*{\addcolon\addspace}\newblock
	\iflistundef{publisher}
		{\printlist{institution}}
		{\printlist{publisher}}%
	\setunit*{\addcomma\addspace}\newblock
	\usebibmacro{date}%
	\iffieldundef{series}
		{}
		{\nopunct\setunit{\addspace}
		 \usebibmacro{series+number}}}

\newbibmacro*{organization}{%
	\iflistundef{organization}
		{}
		{\printlist{organization}%
		 \newunit\newblock
		 \printfield{volume}%
		 \printfield{part}%
		 \clearfield{volume}%
		 \clearfield{part}}}

\newbibmacro*{series+number}{%
	\iffieldundef{series}
		{}
		{\printtext[parens]{%
			\printfield{series}%
			\newunit\newblock
			\printfield{number}}}}

%	Create macros for pagination + volumes
\newbibmacro*{pagetotal/volumes}{%
	\iffieldundef{volumes}
		{\printfield{pagetotal}}%
		{\iffieldundef{volume}
			{\printfield{volumes}}
			{\printfield{pagetotal}}}}

\newbibmacro*{volume+part}{%
	\printfield{volume}%
	\printfield{part}}

\newbibmacro*{chapter+pages}{%
	\printfield{chapter}%
	\setunit{\bibpagespunct}\newblock
	\usebibmacro{pages}}

\newbibmacro*{pages}{%
	\iffieldpages{postnote}
		{}
		{\printfield{pages}}}

%	Create macros for standard book numbers
\newbibmacro*{isbn+doi+eprint+url}{%
	\iftoggle{bbx:isbn}
		{\iffieldundef{isbn}
			{\printfield{issn}}
			{\printfield{isbn}}}%
		{}%
	\setunit{\newblockpunct}\newblock
	\iftoggle{bbx:doi}
		{\printfield{doi}}
		{}%
	\setunit{\newblockpunct}\newblock
	\iftoggle{bbx:eprint}
		{\usebibmacro{eprint}}
		{}%
	\setunit{\newblockpunct}\newblock
	\iftoggle{bbx:url}
		{\usebibmacro{url+urldate}}
		{}}

\newbibmacro*{pubstate+addendum}{%
	\iffieldundef{pubstate}
		{}
		{\newunit\newblock
		 \biblstring{\thefield{pubstate}}}%
	\iffieldundef{addendum}
		{}
		{\setunit{\nopunct\addspace}
		 \printfield[parens]{addendum}}%
	\setunit{\newblockpunct}
	\printfield{note}}

\renewbibmacro*{bibindex}{%
	\ifbibindex
		{\iffieldequalstr{labelnamesource}{shortauthor}
			{\indexnames{author}}
			{\iffieldequalstr{labelnamesource}{shorteditor}
				{\indexnames{editor}}
				{\indexnames{labelname}}}%
		 \indexnames{collaborator}}
		{}}


% #####	DASHES FOR LAST-NAME IN BIBLIOGRAPHY	#####

\InitializeBibliographyStyle{\global\undef\bbx@lasthash}

\newbool{bbx@inset}

\DeclareBibliographyDriver{set}{%
	\booltrue{bbx@inset}%
	\entryset{}{}%
	\newunit\newblock
	\usebibmacro{setpageref}%
	\finentry}

\newbibmacro*{bbx:savehash}{\savefield{fullhash}{\bbx@lasthash}}

\renewbibmacro*{author}{%
	\ifthenelse{	\ifuseauthor\AND\NOT\ifnameundef{author} }
		{\usebibmacro{bbx:dashcheck}
			{\bibnamedash}
			{\printnames{author}%
			 \newunit\newblock
			 \usebibmacro{bbx:savehash}}%
		 \usebibmacro{authorstrg}}
		{\global\undef\bbx@lasthash}%
	\ifnameundef{collaborator}
		{}
		{\bibstring{bycollaborator}%
		 \setunit{\nopunct\addspace}%
		 \printnames{collaborator}}}

\renewbibmacro*{editor}{%
	\usebibmacro{bbx:editor}{editorstrg}}
\renewbibmacro*{editor+others}{%
	\usebibmacro{bbx:editor}{editor+othersstrg}}

\newbibmacro*{bbx:editor}[1]{%
	\ifthenelse{	\ifuseeditor\AND\NOT\ifnameundef{editor} }
		{\usebibmacro{bbx:dashcheck}
			{\bibnamedash}
			{\printnames{editor}%
			 \setunit{\addspace}%
			 \usebibmacro{bbx:savehash}}%
		 \usebibmacro{#1}%
		 \clearname{editor}}
		{\global\undef\bbx@lasthash}}

\renewbibmacro*{translator}{%
	\usebibmacro{bbx:translator}{translatorstrg}}
\renewbibmacro*{translator+others}{%
	\usebibmacro{bbx:translator}{translator+othersstrg}}

\newbibmacro*{bbx:translator}[1]{%
	\ifthenelse{ \ifusetranslator\AND\NOT\ifnameundef{translator} }
		{\usebibmacro{bbx:dashcheck}
			{\bibnamedash}
			{\printnames{translator}%
			 \setunit{\addspace}%
			 \usebibmacro{bbx:savehash}}%
		 \usebibmacro{#1}%
		 \clearname{translator}}
		{\global\undef\bbx@lasthash}}

\newbibmacro*{bbx:dashcheck}[2]{%
	\ifboolexpr{	test {\iffieldequals{fullhash}{\bbx@lasthash}}
					and
					not test \iffirstonpage
					and
						( not bool {bbx@inset}
						or
						test {\iffieldequalstr{entrysetcount}{1}} ) }
		{#1}
		{#2}}

% #####	RELATED FIELD LOOP	#####

\newcounter{bbx:relatedcount}
\newcounter{bbx:relatedtotal}

\def\ifrelatedloop{%
	\ifboolexpr{	test {\xifinlistcs{\strfield{entrykey}}{bbx:relatedloop}}
					or
					test {\xifinlistcs{\strfield{clonesourcekey}}{bbx:relatedloop}} }}

\newbibmacro*{begrelated}{\booltrue{bbx@inset}}
\newbibmacro*{endrelated}{\usebibmacro*{bbx:savehash}}
\newbibmacro*{begrelatedloop}{}
\newbibmacro*{endrelatedloop}{}

\newbibmacro*{related:init}{\csundef{bbx:relatedloop}}

%	Print the related entry using the proper driver, after clearing duplicate fields.
\renewbibmacro*{related:default}[1]{%
	\entrydata*{#1}{%
	 	\usedriver
	 		{% Add related entires to the index (not useful as default)
	 		 %	TODO » Add as an option?
	 		 % \ifbibliography
	 			% {\usebibmacro{bibindex}}
	 			% {\usebibmacro{citeindex}}%
	 		 \ifnameundef{savedauthor}
	 			{\ifthenelse{	\ifnameundef{savededitor} \AND
				 				\ifnamesequal{editor}{savededitor}	}
	 					{\clearname{editor}}
	 					{}}%
	 			{\ifnamesequal{author}{savedauthor}
	 				{\clearname{author}}
	 				{}}%
	 		 \iffieldsequal{title}{savedtitle}
	 		 	{\clearfield{title}}
	 		 	{}%
	 		 % If a <jurisdiction> is related to another <jurisdiction>, use "and"
	 		 \ifthenelse{	\ifentrytype{jurisdiction} \AND
	 		 				\ifnameundef{savedauthor} }
	 		 	{\setunit{\addspace}
	 		 	 \bibstring{and}\nopunct%
	 		 	 \clearlist{institution}%
	 		 	 \clearfield{year}}
	 		 	{}%
	 		 \ifentrytype{commentary}
	 		 	{\ifpunct{}{\setunit{\addcolon\addspace}\newblock}}
	 		 	{}%
	 		 \renewbibmacro*{related:init}{}%
	 		 \DeclareNameAlias{sortname}{default}%
	 		 \ifbibmacroundef{date+extrayear}%	TODO » ???
	 			{}
	 			{\renewbibmacro*{date+extrayear}{}%
	 			 \renewbibmacro*{date}{\printdate}}%
	 		 \renewbibmacro*{pageref}{}}
	 		{\thefield{entrytype}}}}

\newbibmacro*{related}{%
	\ifboolexpr{	test {\iffieldundef{related}}
					or
					test {\ifrelatedloop} }
		{}
		{\usebibmacro{begrelated}%
		 \def\bbx@tempa{}%
		 \setcounter{bbx:relatedtotal}{0}%
		 \def\do##1{%
			\entrydata{##1}{%
				\ifrelatedloop
					{}
					{\stepcounter{bbx:relatedtotal}%
					 \gappto{\bbx@tempa}{##1,}}}}%
		 \docsvfield{related}%
		 \restorefield{related}{\bbx@tempa}%
		 \ifnumgreater{\value{bbx:relatedtotal}}{0}
			{\listcsxadd{bbx:relatedloop}{\strfield{entrykey}}%
			 \iffieldundef{clonesourcekey}
				{}
				{\listcsxadd{bbx:relatedloop}{\strfield{clonesourcekey}}}%
			 \setcounter{bbx:relatedcount}{0}%
			 \def\do{%
				\stepcounter{bbx:relatedcount}%
 				\ifnumgreater{\value{bbx:relatedcount}}{1}
					{\printtext{\relateddelim}}
					{}}%
			 \ifbibmacroundef{related:\strfield{relatedtype}}
				{\appto{\do}{\usebibmacro{related:default}}}
				{\appto{\do}{\usebibmacro*{related:\strfield{relatedtype}}}}%
			 \iffieldformatundef{related:\strfield{relatedtype}}
				{\def\bbx@tempa{related}}
				{\def\bbx@tempa{related:\strfield{relatedtype}}}%
			\iffieldformatundef{relatedstring:\strfield{relatedtype}}
				{\def\bbx@tempb{relatedstring:default}}
				{\def\bbx@tempb{relatedstring:\strfield{relatedtype}}}%
			 \printtext[\bbx@tempa]{%
				\usebibmacro{begrelatedloop}%
				\iffieldundef{relatedstring}
					{\ifboolexpr{	test {\ifnumgreater{\value{bbx:relatedtotal}}{1}}
									and
									test {\ifbibxstring{\thefield{relatedtype}s}} }
						{\printtext[\bbx@tempb]{%
						 \bibstring[\mkrelatedstring]{\thefield{relatedtype}s}}}
						{\iffieldbibstring{relatedtype}
							{\printtext[\bbx@tempb]{%
							 \bibstring[\mkrelatedstring]{\thefield{relatedtype}}}}
							{}}}
					{\iffieldbibstring{relatedstring}
						{\printtext[\bbx@tempb]{%
						 \bibstring[\mkrelatedstring]{\thefield{relatedstring}}}}
						{\printfield[\bbx@tempb]{relatedstring}}}%
				 \docsvfield{related}%
				 \usebibmacro{endrelatedloop}}}%
			{}%
		 \usebibmacro{endrelated}}}

\endinput